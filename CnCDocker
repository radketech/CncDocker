import threading
import time
import re
import os
import json
import sys
import tkinter as tk
from tkinter import filedialog, messagebox

from log_monitor import tail_log_file, stop_log_event
from generate_overlay import generate_placeholder_overlay

SETTINGS_FILE = "settings.json"

DEFAULT_PATH = r"C:\Program Files (x86)\Steam\steamapps\common\CnCRemastered"

# Get the directory where the executable/script is running from
if getattr(sys, 'frozen', False):
    # Running as compiled .exe
    PROGRAM_DIR = os.path.dirname(sys.executable)
else:
    # Running as Python script
    PROGRAM_DIR = os.path.dirname(os.path.abspath(__file__))


def get_log_file_path():
    """Return the path to the log file based on saved cnc_path."""
    return os.path.join(settings["cnc_path"], "log", "LogFile_0.txt")


def validate_cnc_path():
    """Check whether the selected C&C folder contains a valid log file."""
    logfile = get_log_file_path()

    if not os.path.exists(logfile):
        messagebox.showwarning(
            "Log File Not Found",
            f"Could not find:\n{logfile}\n\n"
            "Please confirm your Command & Conquer installation folder."
        )
        return False

    return True


def extract_steam_id():
    """Extract SteamID from log file."""
    logfile = get_log_file_path()

    try:
        with open(logfile, "r", encoding="utf-8", errors="ignore") as f:
            for line in f:
                match = re.search(r"ID:\s*(\d{17})", line)
                if match:
                    return match.group(1)

    except Exception as e:
        messagebox.showerror("Error Reading Log File", str(e))
        return None

    return None


def load_settings():
    """Load settings or create defaults."""
    if not os.path.exists(SETTINGS_FILE):
        settings = {"cnc_path": DEFAULT_PATH, "close_overlay_on_match_complete": False}
        save_settings(settings)
    else:
        with open(SETTINGS_FILE, "r") as f:
            settings = json.load(f)
    return settings


def save_settings(settings):
    with open(SETTINGS_FILE, "w") as f:
        json.dump(settings, f, indent=4)


def select_cnc_path():
    """Prompt user to choose their C&C folder."""
    folder = filedialog.askdirectory(
        title="Select Command & Conquer Installation Folder",
        initialdir=settings["cnc_path"]
    )

    if folder:
        settings["cnc_path"] = folder
        save_settings(settings)
        messagebox.showinfo("Path Updated", f"Saved path:\n{folder}")


def on_run():
    """Start log monitoring thread and create placeholder overlay."""
    if not validate_cnc_path():
        return

    steam_id = extract_steam_id()
    if steam_id:
        print(f"Steam ID: {steam_id}")
    else:
        print("WARNING: Steam ID not found in log yet.")

    logfile_path = get_log_file_path()

    # Generate placeholder overlay in the program directory so user can add it to OBS before playing
    try:
        placeholder_path = generate_placeholder_overlay(output_dir=PROGRAM_DIR)
        if placeholder_path:
            messagebox.showinfo(
                "Overlay Ready",
                f"Placeholder overlay created:\n\n{placeholder_path}\n\n"
                "Add this file as a Browser source in OBS, then start playing!"
            )
    except Exception as e:
        print(f"ERROR creating placeholder: {e}")

    stop_log_event.clear()
    print("Log monitoring started...")

    thread = threading.Thread(
        target=tail_log_file,
        args=(logfile_path, PROGRAM_DIR),
        daemon=True
    )
    thread.start()

    print("Log thread running.\n")


def on_stop():
    print("Stopping log monitor...")
    stop_log_event.set()


# Load settings on startup
settings = load_settings()

# GUI
root = tk.Tk()
root.title("CnC Docker Controller")
root.geometry("300x200")
root.resizable(False, False)

btn_run = tk.Button(root, text="Run", width=20, command=on_run)
btn_run.pack(pady=10)

btn_stop = tk.Button(root, text="Stop", width=20, command=on_stop)
btn_stop.pack(pady=10)

btn_update = tk.Button(root, text="Update C&C Path", width=20, command=select_cnc_path)
btn_update.pack(pady=10)

# Checkbox: Close overlay when match complete
close_var = tk.BooleanVar(value=settings.get("close_overlay_on_match_complete", False))
def _on_close_var_changed():
    settings["close_overlay_on_match_complete"] = bool(close_var.get())
    save_settings(settings)

chk_close = tk.Checkbutton(root, text="Close overlay when match complete", variable=close_var, command=_on_close_var_changed)
chk_close.pack(pady=6)

root.mainloop()
