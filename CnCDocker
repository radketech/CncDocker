import threading
import time
import re
import os
import json
import tkinter as tk
from tkinter import filedialog, messagebox

from log_monitor import tail_log_file, stop_log_event

SETTINGS_FILE = "settings.json"

DEFAULT_PATH = r"C:\Program Files (x86)\Steam\steamapps\common\CnCRemastered"


def get_log_file_path():
    """Return the path to the log file based on saved cnc_path."""
    return os.path.join(settings["cnc_path"], "log", "LogFile_0.txt")


def validate_cnc_path():
    """Check whether the selected C&C folder contains a valid log file."""
    logfile = get_log_file_path()

    if not os.path.exists(logfile):
        messagebox.showwarning(
            "Log File Not Found",
            f"Could not find:\n{logfile}\n\n"
            "Please confirm your Command & Conquer installation folder."
        )
        return False

    return True


def extract_steam_id():
    """Extract SteamID from log file."""
    logfile = get_log_file_path()

    try:
        with open(logfile, "r", encoding="utf-8", errors="ignore") as f:
            for line in f:
                match = re.search(r"ID:\s*(\d{17})", line)
                if match:
                    return match.group(1)

    except Exception as e:
        messagebox.showerror("Error Reading Log File", str(e))
        return None

    return None


def load_settings():
    """Load settings or create defaults."""
    if not os.path.exists(SETTINGS_FILE):
        settings = {"cnc_path": DEFAULT_PATH}
        save_settings(settings)
    else:
        with open(SETTINGS_FILE, "r") as f:
            settings = json.load(f)
    return settings


def save_settings(settings):
    with open(SETTINGS_FILE, "w") as f:
        json.dump(settings, f, indent=4)


def select_cnc_path():
    """Prompt user to choose their C&C folder."""
    folder = filedialog.askdirectory(
        title="Select Command & Conquer Installation Folder",
        initialdir=settings["cnc_path"]
    )

    if folder:
        settings["cnc_path"] = folder
        save_settings(settings)
        messagebox.showinfo("Path Updated", f"Saved path:\n{folder}")


def on_run():
    """Start log monitoring thread."""
    if not validate_cnc_path():
        return

    steam_id = extract_steam_id()
    if steam_id:
        print(f"Steam ID: {steam_id}")
    else:
        print("WARNING: Steam ID not found in log yet.")

    logfile_path = get_log_file_path()

    stop_log_event.clear()
    print("Log monitoring started...")

    thread = threading.Thread(
        target=tail_log_file,
        args=(logfile_path,),
        daemon=True
    )
    thread.start()

    print("Log thread running.cl\n")


def on_stop():
    print("Stopping log monitor...")
    stop_log_event.set()


# Load settings on startup
settings = load_settings()

# GUI
root = tk.Tk()
root.title("CnC Docker Controller")
root.geometry("300x200")
root.resizable(False, False)

btn_run = tk.Button(root, text="Run", width=20, command=on_run)
btn_run.pack(pady=10)

btn_stop = tk.Button(root, text="Stop", width=20, command=on_stop)
btn_stop.pack(pady=10)

btn_update = tk.Button(root, text="Update C&C Path", width=20, command=select_cnc_path)
btn_update.pack(pady=10)

root.mainloop()
